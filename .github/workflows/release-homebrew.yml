name: Update Homebrew formula

on:
  push:
    tags:
      - '*'

jobs:
  update-tap:
    runs-on: ubuntu-22.04
    environment: homebrew-release
    permissions:
      contents: read
    steps:
      - name: Compute tarball metadata
        id: tarball
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          SHA=$(curl -L -s "$URL" | shasum -a 256 | awk '{print $1}')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          repository: onevcat/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap

      - name: Update formula
        env:
          TAP_URL: ${{ steps.tarball.outputs.url }}
          TAP_SHA: ${{ steps.tarball.outputs.sha }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re

          path = pathlib.Path('tap/Formula/xin.rb')
          url = os.environ['TAP_URL']
          sha = os.environ['TAP_SHA']

          if not path.exists():
            path.write_text(f'''class Xin < Formula\n'''
                            f'''  desc "Agent-first JMAP CLI (Fastmail-first)"\n'''
                            f'''  homepage "https://github.com/onevcat/xin"\n'''
                            f'''  url "{url}"\n'''
                            f'''  sha256 "{sha}"\n'''
                            f'''  license "MIT"\n\n'''
                            f'''  depends_on "rust" => :build\n\n'''
                            f'''  def install\n'''
                            f'''    system "cargo", "install", *std_cargo_args\n'''
                            f'''  end\n\n'''
                            f'''  test do\n'''
                            f'''    assert_match "xin", shell_output("#{'{'}bin{'}'}/xin --help")\n'''
                            f'''  end\n'''
                            f'''end\n''')
            print('Created new formula: tap/Formula/xin.rb')
          else:
            text = path.read_text()
            text = re.sub(r'^\s*url\s+".*"\s*$', f'  url "{url}"', text, flags=re.M)
            text = re.sub(r'^\s*sha256\s+".*"\s*$', f'  sha256 "{sha}"', text, flags=re.M)
            path.write_text(text)
            print('Updated formula: tap/Formula/xin.rb')
          PY

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          TAG: ${{ steps.tarball.outputs.tag }}
        run: |
          set -euo pipefail
          cd tap
          BRANCH="xin-${TAG}"
          if gh pr view --repo onevcat/homebrew-tap --head "onevcat:${BRANCH}" >/dev/null 2>&1; then
            echo "PR already exists for ${BRANCH}."
            exit 0
          fi
          git checkout -b "$BRANCH"
          if git diff --quiet; then
            echo "No formula changes detected."
            exit 0
          fi
          git add Formula/xin.rb
          git -c user.name="github-actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "Update xin to ${TAG}"
          git push origin "$BRANCH"
          gh pr create \
            --repo onevcat/homebrew-tap \
            --title "Update xin to ${TAG}" \
            --body-file - <<EOF
          Automated update from xin tag ${TAG}.
          EOF
