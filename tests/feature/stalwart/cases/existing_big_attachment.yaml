id: existing_big_attachment
requiresFresh: true

seed:
  domain: example.org
  users:
    - user: alice
      pass: alice-pass
    - user: bob
      pass: bob-pass
  smtpInject:
    - authUser: bob
      authPass: bob-pass
      mailFrom: bob@example.org
      rcptTo:
        - alice@example.org
      emlFile: tests/feature/stalwart/fixtures/existing_big_attachment.eml

env:
  XIN_BASE_URL: http://127.0.0.1:39090

steps:
  - name: alice-wait-visible-in-search
    say:
      - "Given an external email (bob -> alice) was injected via SMTP"
      - "Then alice should be able to find it via search"
    env:
      XIN_BASIC_USER: alice
      XIN_BASIC_PASS: alice-pass
    retry:
      attempts: 40
      sleepMs: 500
    xin:
      args:
        - messages
        - search
        - --max
        - "5"
    expect:
      - path: /data/items/0/subject
        contains: "[xin-case:existing_big_attachment]"
      - path: /data/items/0/hasAttachment
        equals: true
      - path: /data/items/0/emailId
        exists: true
      - path: /data/items/0/threadId
        exists: true
    save:
      emailId: /data/items/0/emailId
      threadId: /data/items/0/threadId

  - name: alice-get-full-default-limit
    say:
      - "When fetching full email with default maxBodyValueBytes (256KiB)"
      - "Then html body should be marked truncated and warnings should be present"
    env:
      XIN_BASIC_USER: alice
      XIN_BASIC_PASS: alice-pass
    xin:
      args:
        - get
        - ${emailId}
        - --format
        - full
    expect:
      - label: "emailId matches"
        path: /data/email/emailId
        equals: ${emailId}
      - label: "attachment blobId exists"
        path: /data/attachments/0/blobId
        exists: true
      - label: "html is truncated"
        path: /data/body/htmlMeta/isTruncated
        equals: true
      - label: "warnings mention truncation"
        path: /meta/warnings/0
        contains: "body.html truncated"

  - name: alice-thread-get-full
    say:
      - "When fetching the whole thread with --full"
      - "Then per-email body/attachments should be present in the thread output"
    env:
      XIN_BASIC_USER: alice
      XIN_BASIC_PASS: alice-pass
    xin:
      args:
        - thread
        - get
        - ${threadId}
        - --full
    expect:
      - label: "threadId matches"
        path: /data/threadId
        equals: ${threadId}
      - label: "full email item has attachments"
        path: /data/emails/0/attachments/0/name
        equals: "big.bin"
      - label: "html is truncated in thread full"
        path: /data/emails/0/body/htmlMeta/isTruncated
        equals: true

  - name: alice-thread-attachments
    env:
      XIN_BASIC_USER: alice
      XIN_BASIC_PASS: alice-pass
    xin:
      args:
        - thread
        - attachments
        - ${threadId}
    expect:
      - path: /data/attachments/0/emailId
        equals: ${emailId}
      - path: /data/attachments/0/blobId
        exists: true
      - path: /data/attachments/0/name
        equals: "big.bin"
      - path: /data/attachments/0/size
        equals: 300000
    save:
      attachmentEmailId: /data/attachments/0/emailId
      attachmentBlobId: /data/attachments/0/blobId

  - name: alice-download-attachment
    env:
      XIN_BASIC_USER: alice
      XIN_BASIC_PASS: alice-pass
    xin:
      args:
        - attachment
        - ${attachmentEmailId}
        - ${attachmentBlobId}
        - --out
        - tests/feature/stalwart/.state/download-${runId}.bin
    expect:
      - path: /data/bytes
        equals: 300000
