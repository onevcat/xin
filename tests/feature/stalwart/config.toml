# Stalwart config for xin docker feature tests (local-only)
#
# Goals:
# - Provide an HTTP (non-TLS) listener for JMAP + Management API.
# - Use internal directory + RocksDB for a self-contained instance.
# - Keep ports high and bound to localhost via docker port mapping.

[server]
hostname = "127.0.0.1"

# HTTP listener (JMAP at /jmap, discovery at /.well-known/jmap, management API under /api)
[server.listener."http"]
bind = ["0.0.0.0:39090"]
protocol = "http"
tls.implicit = false

# SMTP listener (fixture injection)
[server.listener."smtp"]
bind = ["0.0.0.0:32525"]
protocol = "smtp"
tls.implicit = false

# SMTP AUTH settings for fixture injection (STARTTLS + AUTH PLAIN/LOGIN)
# Local-only harness; do not reuse this config for a real server.
[session.auth]
mechanisms = [
  { if = "listener == 'smtp' && is_tls", then = "[plain, login]" },
  { else = false }
]
directory = [
  { if = "listener == 'smtp'", then = "'internal'" },
  { else = false }
]
require = [
  { if = "listener == 'smtp'", then = true },
  { else = false }
]
allow-plain-text = false
must-match-sender = true

[session.auth.errors]
total = 3
wait = "1s"

[storage]
data = "rocksdb"
fts = "rocksdb"
blob = "rocksdb"
lookup = "rocksdb"
directory = "internal"

[store."rocksdb"]
type = "rocksdb"
path = "%{env:STALWART_PATH}%/data"
compression = "lz4"

[directory."internal"]
type = "internal"
store = "rocksdb"

[tracer."stdout"]
type = "stdout"
level = "info"
ansi = false
enable = true

# Admin credentials for web-admin and management API.
# DO NOT reuse this outside local tests.
[authentication.fallback-admin]
user = "admin"
secret = "%{env:ADMIN_SECRET}%"
